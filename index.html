<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bidu Novel Translator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel Standalone for JSX compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-red-950">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        // Import from CDN
        import { GoogleGenAI, Modality } from "https://esm.run/@google/genai";
        
        const { useState, useCallback, useRef, useEffect } = React;

        // --- COMPONENTS ---
        const LoaderIcon = ({ className = "w-6 h-6" }) => (
            <svg 
              className={`animate-spin ${className}`} 
              xmlns="http://www.w3.org/2000/svg" 
              fill="none" 
              viewBox="0 0 24 24"
            >
              <circle 
                className="opacity-25" 
                cx="12" 
                cy="12" 
                r="10" 
                stroke="currentColor" 
                strokeWidth="4"
              ></circle>
              <path 
                className="opacity-75" 
                fill="currentColor" 
                d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
              ></path>
            </svg>
        );

        const SpeakerIcon = ({ className = "w-6 h-6" }) => (
          <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
            <path strokeLinecap="round" strokeLinejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
          </svg>
        );

        const StopIcon = ({ className = "w-6 h-6" }) => (
          <svg className={className} fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M5 5h10v10H5V5z" clipRule="evenodd" />
          </svg>
        );

        const SettingsIcon = ({ className = "w-6 h-6" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
              <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
        );
        
        const ApiKeyModal = ({ onSave }) => {
            const [inputKey, setInputKey] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                if (inputKey.trim()) {
                    onSave(inputKey.trim());
                }
            };

            return (
                <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 backdrop-blur-sm">
                    <div className="bg-red-900 p-8 rounded-lg shadow-xl max-w-md w-full border border-red-800">
                        <h2 className="text-2xl font-bold mb-4 text-white">Enter Gemini API Key</h2>
                        <p className="text-gray-400 mb-6">
                            To use this translator, you need a Google Gemini API key. You can get one for free from{' '}
                            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="text-blue-400 hover:underline">
                                Google AI Studio
                            </a>.
                        </p>
                        <form onSubmit={handleSubmit}>
                            <input
                                type="password"
                                value={inputKey}
                                onChange={(e) => setInputKey(e.target.value)}
                                placeholder="Enter your API key here"
                                className="w-full p-3 mb-4 bg-red-800 border border-red-700 rounded-lg text-white placeholder-red-400 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                autoFocus
                            />
                            <button
                                type="submit"
                                disabled={!inputKey.trim()}
                                className="w-full px-6 py-3 rounded-lg font-bold text-white transition-colors bg-blue-600 hover:bg-blue-700 disabled:bg-red-700 disabled:cursor-not-allowed"
                            >
                                Save and Continue
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        // --- SERVICES (GEMINI API & AUDIO HELPERS) ---
        function decode(base64) {
          const binaryString = atob(base64);
          const len = binaryString.length;
          const bytes = new Uint8Array(len);
          for (let i = 0; i < len; i++) {
            bytes[i] = binaryString.charCodeAt(i);
          }
          return bytes;
        }

        async function decodeAudioData(data, ctx, sampleRate, numChannels) {
          const dataInt16 = new Int16Array(data.buffer);
          const frameCount = dataInt16.length / numChannels;
          const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

          for (let channel = 0; channel < numChannels; channel++) {
            const channelData = buffer.getChannelData(channel);
            for (let i = 0; i < frameCount; i++) {
              channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
            }
          }
          return buffer;
        }

        async function translateText(text, novelTitle, apiKey) {
          if (!text) throw new Error("Input text cannot be empty.");
          if (!apiKey) throw new Error("API Key is missing.");
          
          const ai = new GoogleGenAI({ apiKey });
          const model = 'gemini-2.5-pro';
          const contextInstruction = novelTitle 
            ? `The title of this novel is "${novelTitle}". Keep this in mind for consistent translation of names and terms.`
            : '';
          const prompt = `Translate the following Chinese novel text into fluent and natural-sounding Indonesian. Preserve the original paragraph structure, line breaks, and any special formatting (like dialogue markers).\n${contextInstruction}\n\nChinese Text:\n---\n${text}\n---\n\nIndonesian Translation:`;
          
          try {
            const response = await ai.models.generateContent({ model, contents: prompt });
            return response.text;
          } catch (error) {
            console.error("Error calling Gemini API for translation:", error);
            throw new Error(`Failed to get translation. ${error.message || ''}`.trim());
          }
        }

        async function generateSpeech(text, voiceName, apiKey) {
            if (!text) throw new Error("Input text for speech generation cannot be empty.");
            if (!voiceName) throw new Error("A voice name must be provided.");
            if (!apiKey) throw new Error("API Key is missing.");

            const ai = new GoogleGenAI({ apiKey });
            const model = 'gemini-2.5-flash-preview-tts';
            
            try {
                const response = await ai.models.generateContent({
                    model: model,
                    contents: [{ parts: [{ text }] }],
                    config: {
                        responseModalities: [Modality.AUDIO],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName },
                            },
                        },
                    },
                });

                const base64Audio = response.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (!base64Audio) throw new Error("API did not return audio data.");
                return base64Audio;
            } catch (error) {
                console.error("Error calling Gemini API for TTS:", error);
                throw new Error(`Failed to generate speech. ${error.message || ''}`.trim());
            }
        }

        // --- MAIN APP COMPONENT ---
        const App = () => {
            const [novelTitle, setNovelTitle] = useState('');
            const [originalText, setOriginalText] = useState('');
            const [translatedText, setTranslatedText] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [error, setError] = useState(null);
            
            const [isTtsLoading, setIsTtsLoading] = useState(false);
            const [isPlaying, setIsPlaying] = useState(false);
            const [selectedTtsVoice, setSelectedTtsVoice] = useState('Zephyr');
            const audioContextRef = useRef(null);
            const audioSourceRef = useRef(null);

            const [apiKey, setApiKey] = useState('');
            const [isApiKeyModalOpen, setIsApiKeyModalOpen] = useState(false);

            useEffect(() => {
                const savedKey = localStorage.getItem('gemini-api-key');
                if (savedKey) {
                    setApiKey(savedKey);
                } else {
                    setIsApiKeyModalOpen(true);
                }
            }, []);

            const handleSaveApiKey = (key) => {
                localStorage.setItem('gemini-api-key', key);
                setApiKey(key);
                setIsApiKeyModalOpen(false);
                setError(null);
            };

            const ttsVoices = ['Zephyr', 'Kore', 'Puck', 'Charon', 'Fenrir'];

            const stopTts = useCallback(() => {
                if (audioSourceRef.current) {
                    audioSourceRef.current.stop();
                    audioSourceRef.current.disconnect();
                    audioSourceRef.current = null;
                }
                setIsPlaying(false);
            }, []);
            
            const handleTranslate = useCallback(async () => {
                stopTts();
                if (!originalText.trim()) {
                    setError('Please enter some text to translate.');
                    return;
                }
                if (!apiKey) {
                    setError('API Key is not set. Please set one in the settings.');
                    setIsApiKeyModalOpen(true);
                    return;
                }
                if (isLoading) return;

                setIsLoading(true);
                setError(null);
                setTranslatedText('');

                try {
                    setLoadingMessage('Translating...');
                    const translation = await translateText(originalText, novelTitle, apiKey);
                    setTranslatedText(translation);
                } catch (err) {
                    if (String(err.message).includes('API key not valid')) {
                        setError('Your API key is invalid. Please check and re-enter it.');
                        localStorage.removeItem('gemini-api-key');
                        setApiKey('');
                        setIsApiKeyModalOpen(true);
                    } else {
                        setError(`Translation failed: ${err.message}`);
                    }
                    console.error(err);
                } finally {
                    setIsLoading(false);
                    setLoadingMessage('');
                }
            }, [originalText, isLoading, novelTitle, stopTts, apiKey]);

            const handlePlayTts = useCallback(async () => {
                if (isPlaying) {
                    stopTts();
                    return;
                }
                if (!translatedText) {
                    setError("No translated text to play.");
                    return;
                }
                if (!apiKey) {
                    setError('API Key is not set. Please set one in the settings.');
                    setIsApiKeyModalOpen(true);
                    return;
                }

                setIsTtsLoading(true);
                setError(null);

                try {
                    if (!audioContextRef.current) {
                        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 24000 });
                    }
                    if (audioContextRef.current.state === 'suspended') {
                        await audioContextRef.current.resume();
                    }

                    const base64Audio = await generateSpeech(translatedText, selectedTtsVoice, apiKey);
                    const audioData = decode(base64Audio);
                    const audioBuffer = await decodeAudioData(audioData, audioContextRef.current, 24000, 1);

                    const source = audioContextRef.current.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(audioContextRef.current.destination);
                    source.start(0);
                    source.onended = () => {
                        setIsPlaying(false);
                        audioSourceRef.current = null;
                    };

                    audioSourceRef.current = source;
                    setIsPlaying(true);
                } catch (err) {
                    if (String(err.message).includes('API key not valid')) {
                        setError('Your API key is invalid. Please check and re-enter it.');
                        localStorage.removeItem('gemini-api-key');
                        setApiKey('');
                        setIsApiKeyModalOpen(true);
                    } else {
                        setError(`TTS failed: ${err.message}`);
                    }
                    console.error(err);
                } finally {
                    setIsTtsLoading(false);
                }
            }, [translatedText, isPlaying, stopTts, selectedTtsVoice, apiKey]);

            return (
                <div className="flex flex-col min-h-screen bg-red-950 text-gray-200 font-sans">
                  {isApiKeyModalOpen && <ApiKeyModal onSave={handleSaveApiKey} />}
                  <header className="bg-red-900/50 backdrop-blur-sm border-b border-red-800 p-4 sticky top-0 z-10">
                    <div className="container mx-auto flex justify-between items-center">
                        <div className="w-8"></div> {/* Spacer */}
                        <div className="text-center">
                            <h1 className="text-2xl md:text-3xl font-bold text-gray-100">
                              Novel Translator
                            </h1>
                            <p className="text-gray-400 text-sm mt-1">
                              Translate Chinese novel chapters to Indonesian by pasting the text below
                            </p>
                        </div>
                        <button onClick={() => setIsApiKeyModalOpen(true)} className="text-gray-400 hover:text-white transition-colors" title="Settings / Change API Key">
                            <SettingsIcon className="w-7 h-7" />
                        </button>
                    </div>
                  </header>

                  <main className="flex-grow container mx-auto p-4 md:p-6 grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 pb-28 md:pb-24">
                    <div className="flex flex-col" style={{ minHeight: '60vh' }}>
                      <label htmlFor="novel-title" className="mb-2 font-semibold text-gray-400">Novel Title (for context)</label>
                      <input
                        id="novel-title"
                        type="text"
                        value={novelTitle}
                        onChange={(e) => setNovelTitle(e.target.value)}
                        placeholder="e.g., Renegade Immortal (仙逆)"
                        disabled={isLoading}
                        className="p-3 mb-4 bg-red-900 border border-red-800 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors text-gray-200 placeholder-red-400"
                      />
                      <label htmlFor="original-text" className="mb-2 font-semibold text-gray-400">Original Chinese Text</label>
                      <textarea
                        id="original-text"
                        value={originalText}
                        onChange={(e) => setOriginalText(e.target.value)}
                        placeholder="Paste the original Chinese text here."
                        className="flex-grow p-4 bg-red-900 border border-red-800 rounded-lg resize-none text-gray-300 placeholder-red-400"
                      />
                    </div>

                    <div className="flex flex-col">
                      <div className="flex justify-between items-center mb-2 gap-2">
                        <label htmlFor="translated-text" className="font-semibold text-gray-400">Indonesian Translation</label>
                        <div className="flex items-center gap-2">
                           <select
                            value={selectedTtsVoice}
                            onChange={(e) => setSelectedTtsVoice(e.target.value)}
                            disabled={isTtsLoading || isPlaying || !apiKey}
                            className="bg-red-800 border border-red-700 text-white text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-1.5 disabled:opacity-50"
                            aria-label="Select TTS Voice"
                          >
                            {ttsVoices.map(voice => (
                              <option key={voice} value={voice}>{voice}</option>
                            ))}
                          </select>
                          <button
                            onClick={handlePlayTts}
                            disabled={isTtsLoading || !translatedText || !apiKey}
                            className="px-3 py-1.5 rounded-lg font-semibold text-white bg-green-600 hover:bg-green-700 transition-colors disabled:bg-red-700 disabled:cursor-not-allowed flex items-center gap-2"
                            aria-label={isPlaying ? "Stop audio" : "Play audio"}
                          >
                            {isTtsLoading ? (
                              <LoaderIcon className="w-5 h-5" />
                            ) : isPlaying ? (
                              <StopIcon className="w-5 h-5" />
                            ) : (
                              <SpeakerIcon className="w-5 h-5" />
                            )}
                            <span>{isPlaying ? 'Stop' : 'Play'}</span>
                          </button>
                        </div>
                      </div>
                      <div id="translated-text" className="flex-grow p-4 bg-red-900 border border-red-800 rounded-lg relative overflow-y-auto" style={{ minHeight: '60vh' }}>
                        {isLoading && (
                          <div className="absolute inset-0 flex flex-col items-center justify-center bg-red-900/70 z-10">
                            <LoaderIcon className="w-12 h-12 text-blue-500" />
                            <p className="mt-4 text-lg text-gray-300">{loadingMessage}</p>
                          </div>
                        )}
                        {!isLoading && !translatedText && (
                          <div className="flex items-center justify-center h-full text-gray-500">
                            {apiKey ? "Translation will appear here." : "Please set your API Key in the settings."}
                          </div>
                        )}
                        <pre className="whitespace-pre-wrap break-words font-sans text-gray-200">
                          {translatedText}
                        </pre>
                      </div>
                    </div>
                  </main>

                  <footer className="bg-red-900/50 backdrop-blur-sm border-t border-red-800 p-4 fixed bottom-0 w-full z-20">
                    <div className="container mx-auto flex flex-col sm:flex-row items-center justify-between gap-4">
                      {error && (
                        <div className="text-red-400 text-sm text-center sm:text-left flex-grow">
                          <span className="font-bold">Error:</span> {error}
                        </div>
                      )}
                       <div className={`flex-grow ${error ? 'sm:block hidden' : ''}`}></div>
                      <button
                        onClick={handleTranslate}
                        disabled={isLoading || !originalText.trim() || !apiKey}
                        className={`w-full sm:w-auto px-8 py-3 rounded-lg font-bold text-white transition-all duration-300 ease-in-out focus:outline-none focus:ring-4 focus:ring-red-500/50 ${
                          isLoading
                            ? 'bg-red-700 cursor-not-allowed'
                            : 'bg-gradient-to-r from-orange-500 to-red-600 hover:from-orange-600 hover:to-red-700'
                        } disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2`}
                      >
                        {isLoading ? (
                          <>
                            <LoaderIcon className="w-5 h-5" />
                            <span>Translating...</span>
                          </>
                        ) : (
                          <span>Translate</span>
                        )}
                      </button>
                    </div>
                  </footer>
                </div>
            );
        };
        
        // --- RENDER THE APP ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>